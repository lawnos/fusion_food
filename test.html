case "dathang":
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $select_pay = $_POST['phuongthucthanhtoan'];

    // Thanh toán bằng tiền mặt
    if ($select_pay == "tienmat") {
        date_default_timezone_set('Asia/Ho_Chi_Minh');
        $ngaymua = date("Y-m-d H:i:s");
        $ma_donhang = rand(0, 9999);
        $_SESSION["madonhang"] = $ma_donhang;

        if (isset($_SESSION["user"])) {
            $id = $_SESSION["user"];
            $loai_thanhtoan = "Tiền mặt";

            try {
                insert_bill($id, $ma_donhang, $ngaymua, $loai_thanhtoan);
                foreach ($_SESSION["cart"] as $key => $value) {
                    extract($value);
                    insert_bill_detail($ma_donhang, $id_monan, $soluongmua);
                }

                // Hiển thị chi tiết hóa đơn đã chèn
                $pdo = new PDO('mysql:host=localhost;dbname=fusion_food', 'username', 'password');
                $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
                $stmt = $pdo->prepare("SELECT * FROM tbl_hoadon WHERE ma_donhang = ?");
                $stmt->execute([$ma_donhang]);
                $data = $stmt->fetch(PDO::FETCH_ASSOC);

                echo "<pre>Inserted Data: " . print_r($data, true) . "</pre>";
            } catch (Exception $e) {
                echo "Error: " . $e->getMessage();
            }
        }

        // Gửi mail
        submitmail();

        unset($_SESSION["cart"]);
        unset($_SESSION["madonhang"]);
        echo "<script>alert('Đặt hàng thành công');</script>";
        include("./views/main/camon.php");

        // Thanh toán bằng vnpay
    } else if ($select_pay == "vnp") {
        $ma_donhang = rand(0, 9999);
        $_SESSION["madonhang"] = $ma_donhang;
        $vnp_TxnRef = $ma_donhang;

        $tongtien = 0;
        foreach ($_SESSION["cart"] as $key => $value) {
            extract($value);
            $thanhtien = $value['soluongmua'] * $value['gia_monan'];
            $tongtien += $thanhtien;
        }

        $vnp_OrderInfo = "Thanh toán đơn hàng đặt tại Fusion Food";
        $vnp_OrderType = "Billpayment";
        $vnp_Amount = $tongtien * 100;
        $vnp_Locale = "VN";
        $vnp_BankCode = "NCB";
        $vnp_IpAddr = $_SERVER['REMOTE_ADDR'];
        $vnp_ExpireDate = $expire;
        $inputData = array(
            "vnp_Version" => "2.1.0",
            "vnp_TmnCode" => $vnp_TmnCode,
            "vnp_Amount" => $vnp_Amount,
            "vnp_Command" => "pay",
            "vnp_CreateDate" => date('YmdHis'),
            "vnp_CurrCode" => "VND",
            "vnp_IpAddr" => $vnp_IpAddr,
            "vnp_Locale" => $vnp_Locale,
            "vnp_OrderInfo" => $vnp_OrderInfo,
            "vnp_OrderType" => $vnp_OrderType,
            "vnp_ReturnUrl" => $vnp_Returnurl,
            "vnp_TxnRef" => $vnp_TxnRef,
            "vnp_ExpireDate" => $vnp_ExpireDate
        );

        if (isset($vnp_BankCode) && $vnp_BankCode != "") {
            $inputData['vnp_BankCode'] = $vnp_BankCode;
        }

        ksort($inputData);
        $query = "";
        $hashdata = "";
        $i = 0;
        foreach ($inputData as $key => $value) {
            if ($i == 1) {
                $hashdata .= '&' . urlencode($key) . "=" . urlencode($value);
            } else {
                $hashdata .= urlencode($key) . "=" . urlencode($value);
                $i = 1;
            }
            $query .= urlencode($key) . "=" . urlencode($value) . '&';
        }

        $vnp_Url = $vnp_Url . "?" . $query;
        if (isset($vnp_HashSecret)) {
            $vnpSecureHash = hash_hmac('sha512', $hashdata, $vnp_HashSecret);
            $vnp_Url .= 'vnp_SecureHash=' . $vnpSecureHash;
        }
        $returnData = array(
            'code' => '00',
            'message' => 'success',
            'data' => $vnp_Url
        );

        if (isset($_POST['redirect'])) {
            echo '<script>window.location.href = "' . $vnp_Url . '";</script>';
            die();
        } else {
            echo json_encode($returnData);
        }

        // Thanh toán bằng MomoATM
    } else if ($select_pay == "momo") {
        header('Content-type: text/html; charset=utf-8');

        function execPostRequest($url, $data)
        {
            $ch = curl_init($url);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
            curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt(
                $ch,
                CURLOPT_HTTPHEADER,
                array(
                    'Content-Type: application/json',
                    'Content-Length: ' . strlen($data)
                )
            );
            curl_setopt($ch, CURLOPT_TIMEOUT, 5);
            curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);
            $result = curl_exec($ch);
            curl_close($ch);
            return $result;
        }

        $endpoint = "https://test-payment.momo.vn/v2/gateway/api/create";

        $partnerCode = 'MOMOBKUN20180529';
        $accessKey = 'klm05TvNBzhg7h7j';
        $secretKey = 'at67qH6mk8w5Y1nAyMoYKMWACiEi2bsa';

        $orderInfo = "Thanh toán qua MoMo";
        $amount = $_POST["tongtien"];
        $orderId = $_POST["ma_donhang"];
        $redirectUrl = "http://localhost/fusionfood/index.php?act=camon-momo";
        $ipnUrl = "http://localhost/fusionfood/index.php?act=camon-momo";
        $extraData = ($_POST["extraData"] ? $_POST["extraData"] : "");

        $requestId = time() . "";
        $requestType = "payWithATM";
        $rawHash = "accessKey=" . $accessKey . "&amount=" . $amount . "&extraData=" . $extraData . "&ipnUrl=" . $ipnUrl . "&orderId=" . $orderId . "&orderInfo=" . $orderInfo . "&partnerCode=" . $partnerCode . "&redirectUrl=" . $redirectUrl . "&requestId=" . $requestId . "&requestType=" . $requestType;
        $signature = hash_hmac("sha256", $rawHash, $secretKey);
        $data = array(
            'partnerCode' => $partnerCode,
            'partnerName' => "Test",
            "storeId" => "MomoTestStore",
            'requestId' => $requestId,
            'amount' => $amount,
            'orderId' => $orderId,
            'orderInfo' => $orderInfo,
            'redirectUrl' => $redirectUrl,
            'ipnUrl' => $ipnUrl,
            'lang' => 'vi',
            'extraData' => $extraData,
            'requestType' => $requestType,
            'signature' => $signature
        );
        $result = execPostRequest($endpoint, json_encode($data));
        $jsonResult = json_decode($result, true);

        header('Location: ' . $jsonResult['payUrl']);
    }
}
break;